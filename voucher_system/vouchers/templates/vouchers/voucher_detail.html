{% extends 'base.html' %}
{% load static %}
{% load voucher_tags %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">Voucher {{ voucher.voucher_number }}</h5>
        </div>
        <div class="card-body">
            <p><strong>Date:</strong> {{ voucher.voucher_date }}</p>
            <p><strong>Payment Type:</strong> {{ voucher.get_payment_type_display }}</p>
            <p><strong>Pay To:</strong> {{ voucher.name_title }} {{ voucher.pay_to }}</p>

            <p><strong>Status:</strong>
                <a href="#" class="status-link" data-bs-toggle="modal" data-bs-target="#approvalModal">
                    <span id="status-badge">
                        {% if voucher.status == 'PENDING' %}
                            <span class="badge bg-warning text-dark">Pending</span>
                        {% elif voucher.status == 'APPROVED' %}
                            <span class="badge bg-success">Approved</span>
                        {% elif voucher.status == 'REJECTED' %}
                            <span class="badge bg-danger">Rejected</span>
                        {% endif %}
                    </span>
                </a>
            </p>

            <p><strong>Created By:</strong> {{ voucher.created_by.username }}</p>
            <p><strong>Created At:</strong> {{ voucher.created_at|date:"d M Y H:i" }}</p>

            <hr>

            <!-- MAIN ATTACHMENT -->
            {% if voucher.attachment %}
            <p><strong>Main Attachment:</strong>
                <a href="{{ voucher.attachment.url }}" target="_blank" class="btn btn-outline-secondary btn-sm">
                    View File
                </a>
            </p>
            {% endif %}

            <!-- PARTICULARS -->
            <h6>Particulars</h6>
            {% if voucher.particulars.exists %}
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Description</th>
                                <th class="text-end">Amount</th>
                                <th>Attachment</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in voucher.particulars.all %}
                            <tr>
                                <td>{{ p.description }}</td>
                                <td class="text-end">{{ p.amount|floatformat:2 }}</td>
                                <td>
                                    {% if p.attachment %}
                                        <a href="{{ p.attachment.url }}" target="_blank"
                                           class="btn btn-sm btn-outline-primary">
                                            View File
                                        </a>
                                    {% else %}
                                        <span class="text-muted">â€”</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            <tr class="table-primary">
                                <td colspan="2"><strong>Total</strong></td>
                                <td class="text-end"><strong>{{ voucher.particulars.all|sum_particulars|floatformat:2 }}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted">No particulars</p>
            {% endif %}

            <hr>

            <!-- APPROVAL PROGRESS -->
            <div class="mt-3">
                <strong>Approval Progress:</strong>
                <div class="progress mt-2" style="height: 30px;">
                    <div id="progress-bar" class="progress-bar bg-success"
                         style="width: {{ approval_percentage }}%">
                        {{ voucher.approved_count|default:0 }} / {{ voucher.required_approvers|length }}
                    </div>
                </div>
                <small id="required-list" class="text-muted">
                    Required: {{ voucher.required_approvers|join:", " }}
                </small>
            </div>

            <hr>

            <div class="d-flex gap-2">
                <a href="{% url 'voucher_list' %}" class="btn btn-secondary">Back to List</a>

                {% if user.groups.all.0.name == 'Admin Staff' and voucher.status == 'PENDING' %}
                    {% if not user_approval %}
                        <button class="btn btn-success approve-btn" data-id="{{ voucher.id }}" data-status="APPROVED">
                            Approve
                        </button>
                        <button class="btn btn-danger approve-btn" data-id="{{ voucher.id }}" data-status="REJECTED">
                            Reject
                        </button>
                    {% else %}
                        {% if user_approval.status == 'APPROVED' %}
                            <button class="btn btn-success" disabled>Approved</button>
                        {% else %}
                            <button class="btn btn-danger" disabled>Rejected</button>
                        {% endif %}
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- APPROVAL MODAL -->
<div class="modal fade" id="approvalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Approval Details - {{ voucher.voucher_number }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6 class="text-success">Approved ({{ voucher.approved_count|default:0 }})</h6>
                        <ul class="list-group">
                            {% for approval in voucher.approvals.all %}
                                {% if approval.status == 'APPROVED' %}
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>{{ approval.approver.username }}</span>
                                        <small class="text-muted">{{ approval.approved_at|date:"d M H:i" }}</small>
                                    </li>
                                {% endif %}
                            {% empty %}
                                <li class="list-group-item text-muted">None</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-danger">Rejected ({{ voucher.rejected_count|default:0 }})</h6>
                        <ul class="list-group">
                            {% for approval in voucher.approvals.all %}
                                {% if approval.status == 'REJECTED' %}
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>{{ approval.approver.username }}</span>
                                        <small class="text-muted">{{ approval.approved_at|date:"d M H:i" }}</small>
                                    </li>
                                {% endif %}
                            {% empty %}
                                <li class="list-group-item text-muted">None</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-secondary">
                            Pending ({{ voucher.required_approvers|length|sub:voucher.approved_count|default:0 }})
                        </h6>
                        <ul class="list-group">
                            {% for item in pending_approvers %}
                                {% if not item.has_approved %}
                                    <li class="list-group-item">{{ item.name }}</li>
                                {% endif %}
                            {% empty %}
                                <li class="list-group-item text-muted">No one required</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;

    document.querySelectorAll('.approve-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const id = this.dataset.id;
            const status = this.dataset.status;
            const isApprove = status === 'APPROVED';

            document.querySelectorAll('.approve-btn').forEach(b => {
                b.disabled = true;
                b.style.opacity = '0.6';
            });

            fetch(`/api/vouchers/${id}/approve/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf
                },
                body: JSON.stringify({ status })
            })
            .then(r => r.json())
            .then(data => {
                this.textContent = isApprove ? 'Approved' : 'Rejected';
                this.className = isApprove ? 'btn btn-success' : 'btn btn-danger';
                this.disabled = true;

                const other = document.querySelector(`.approve-btn[data-status="${isApprove ? 'REJECTED' : 'APPROVED'}"]`);
                if (other) other.style.display = 'none';

                const badge = document.getElementById('status-badge');
                if (data.status === 'APPROVED')
                    badge.innerHTML = '<span class="badge bg-success">Approved</span>';
                else if (data.status === 'REJECTED')
                    badge.innerHTML = '<span class="badge bg-danger">Rejected</span>';
                else
                    badge.innerHTML = '<span class="badge bg-warning text-dark">Pending</span>';

                const total = data.required_approvers.length;
                const approved = data.approved_count;
                const percent = total > 0 ? (approved / total) * 100 : 0;
                const bar = document.getElementById('progress-bar');
                bar.style.width = `${percent}%`;
                bar.textContent = `${approved} / ${total}`;
                document.getElementById('required-list').textContent = `Required: ${data.required_approvers.join(', ')}`;
            })
            .catch(() => {
                alert('Approval failed.');
                document.querySelectorAll('.approve-btn').forEach(b => {
                    b.disabled = false;
                    b.style.opacity = '1';
                });
            });
        });
    });
});
</script>
{% endblock %}